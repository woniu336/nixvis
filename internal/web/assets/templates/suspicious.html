<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .title }}</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/tables.css">
    <link rel="stylesheet" href="/static/css/media.css">
    <style>
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 80px;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
            box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
        }

        .btn-danger:hover {
            background-color: #c82333;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.4);
        }

        .btn-danger:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(220, 53, 69, 0.3);
        }

        .btn-disabled {
            background-color: #6c757d;
            color: white;
            cursor: not-allowed;
            opacity: 0.7;
            box-shadow: none;
        }

        .btn-disabled:hover {
            transform: none;
            box-shadow: none;
            background-color: #6c757d;
        }

        .blocked {
            color: #28a745;
            font-weight: bold;
        }

        .unblocked {
            color: #dc3545;
            font-weight: bold;
        }

        /* è¡¨æ ¼æ ·å¼æ”¹è¿› */
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            margin-top: 15px;
            box-shadow: 0 2px 8px var(--shadow-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .stats-table thead {
            background-color: var(--active-btn);
            color: var(--active-text);
        }

        .stats-table th {
            padding: 16px 12px;
            text-align: left;
            font-weight: 600;
            border: none;
        }

        .stats-table td {
            padding: 14px 12px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }

        .stats-table tbody tr {
            transition: background-color 0.2s ease;
        }

        .stats-table tbody tr:hover {
            background-color: var(--highlight-bg);
        }

        .stats-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* å“åº”å¼è¡¨æ ¼ */
        @media (max-width: 768px) {
            .stats-table {
                font-size: 13px;
            }

            .stats-table th,
            .stats-table td {
                padding: 10px 8px;
            }
        }

        /* é¡µé¢æ ‡é¢˜æ ·å¼ */
        .box-container h2 {
            color: var(--header-color);
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border-color);
            font-size: 1.5rem;
        }

        /* åŠ è½½çŠ¶æ€æ ·å¼ */
        #loading {
            text-align: center;
            padding: 40px;
            color: var(--text-color);
            opacity: 0.7;
            font-size: 16px;
        }

        /* ç©ºçŠ¶æ€æ ·å¼ */
        .stats-table td[colspan="5"] {
            text-align: center;
            padding: 40px;
            color: var(--text-color);
            opacity: 0.6;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header-container">
            <h1>
                <select id="website-selector" class="website-dropdown">
                    <option value="">åŠ è½½ä¸­...</option>
                </select> å¯ç–‘ IP ç®¡ç†
            </h1>
            <div class="header-actions">
                <a href="/" class="nav-button">ğŸ  é¦–é¡µ</a>
                <a href="/spiders" id="spiders-link" class="nav-button">ğŸ•·ï¸ èœ˜è››ç»Ÿè®¡</a>
                <a href="/settings" class="nav-button">âš™ï¸ è®¾ç½®</a>
            </div>
        </header>

        <div class="box-container">
            <h2>å¯ç–‘ IP åˆ—è¡¨ (æœ€å¤š20æ¡ï¼ŒæŒ‰è®¿é—®æ¬¡æ•°æ’åº)</h2>
            <div id="loading">åŠ è½½ä¸­...</div>
            <div id="suspicious-list" style="display: none;">
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>IP åœ°å€</th>
                            <th>è®¿é—®æ¬¡æ•°</th>
                            <th>ç±»å‹</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="suspicious-table-body">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadWebsites();
        });

        function loadWebsites() {
            fetch('/api/websites')
                .then(response => response.json())
                .then(data => {
                    const selector = document.getElementById('website-selector');
                    selector.innerHTML = '';
                    data.websites.forEach(site => {
                        const option = document.createElement('option');
                        option.value = site.id;
                        option.textContent = site.name;
                        selector.appendChild(option);
                    });

                    // ä»URLå‚æ•°è·å–ç½‘ç«™IDï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ç¬¬ä¸€ä¸ª
                    const urlParams = new URLSearchParams(window.location.search);
                    let websiteId = urlParams.get('id');

                    if (!websiteId && data.websites.length > 0) {
                        websiteId = data.websites[0].id;
                    }

                    if (websiteId) {
                        selector.value = websiteId;
                        loadSuspiciousIPs(websiteId);
                    }
                });
        }

        document.getElementById('website-selector').addEventListener('change', function() {
            const websiteId = this.value;
            // æ›´æ–°URLå‚æ•°å’Œèœ˜è››é“¾æ¥
            const url = new URL(window.location);
            url.searchParams.set('id', websiteId);
            window.history.pushState({}, '', url);
            updateSpidersLink(websiteId);
            loadSuspiciousIPs(websiteId);
        });

        function loadSuspiciousIPs(websiteId) {
            // æ›´æ–°èœ˜è››é“¾æ¥
            updateSpidersLink(websiteId);
            document.getElementById('loading').style.display = 'block';
            document.getElementById('suspicious-list').style.display = 'none';

            fetch(`/api/suspicious?id=${websiteId}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('suspicious-list').style.display = 'block';

                    const ips = data.suspicious_ips || [];
                    updateSuspiciousTable(ips);
                })
                .catch(error => {
                    console.error('åŠ è½½å¯ç–‘ IP å¤±è´¥:', error);
                    document.getElementById('loading').textContent = 'åŠ è½½å¤±è´¥';
                });
        }

        function updateSuspiciousTable(ips) {
            const tbody = document.getElementById('suspicious-table-body');
            tbody.innerHTML = '';

            ips.forEach(ip => {
                const row = document.createElement('tr');
                const isBlocked = ip.is_blocked === 1;

                row.innerHTML = `
                    <td>${ip.ip}</td>
                    <td>${ip.access_count}</td>
                    <td>${ip.reason_type}</td>
                    <td>${isBlocked ? '<span class="blocked">å·²å±è”½</span>' : '<span class="unblocked">æœªå±è”½</span>'}</td>
                    <td>
                        ${isBlocked ?
                            '<button class="btn btn-disabled" disabled>å·²å±è”½</button>' :
                            `<button class="btn btn-danger" onclick="blockIP('${ip.ip}', '${ip.website_id}')">å±è”½</button>`
                        }
                    </td>
                `;
                tbody.appendChild(row);
            });

            if (ips.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="5" style="text-align: center;">æš‚æ— å¯ç–‘ IP</td>';
                tbody.appendChild(row);
            }
        }

        function updateSpidersLink(websiteId) {
            const spidersLink = document.getElementById('spiders-link');
            if (spidersLink && websiteId) {
                spidersLink.href = `/spiders?id=${websiteId}`;
            }
        }

        function blockIP(ip, websiteId) {
            if (!confirm(`ç¡®å®šè¦å±è”½ IP ${ip} å—ï¼Ÿæ­¤æ“ä½œå°†è°ƒç”¨ç³»ç»Ÿçš„ iptables/ipset å‘½ä»¤ã€‚`)) {
                return;
            }

            fetch('/api/block', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    ip: ip,
                    website_id: websiteId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    loadSuspiciousIPs(websiteId);
                } else {
                    alert('å±è”½å¤±è´¥: ' + data.message);
                }
            })
            .catch(error => {
                console.error('å±è”½å¤±è´¥:', error);
                alert('å±è”½å¤±è´¥: ' + error.message);
            });
        }
    </script>
</body>
</html>
